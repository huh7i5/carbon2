<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºè°±AIé›†æˆæµ‹è¯• - æ²ªç¢³æ™ºè„‘</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #1a252f;
            color: white;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #00d4aa;
        }
        
        .test-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h3 {
            color: #00d4aa;
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #a0a0a0;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a3441;
            color: white;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #00d4aa;
            color: white;
        }
        
        .btn-secondary {
            background: #666;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .result {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .result.loading {
            color: #ffc107;
        }
        
        .result.success {
            border-color: #00d4aa;
        }
        
        .result.error {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status.online {
            background: rgba(0, 212, 170, 0.2);
            color: #00d4aa;
        }
        
        .status.offline {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– æ™ºè°±AIé›†æˆæµ‹è¯•</h1>
            <p>æ²ªç¢³æ™ºè„‘å¹³å° - æ™ºè°±AI GLM-4.5 æ¨¡å‹æµ‹è¯•ç•Œé¢</p>
            <div>
                åç«¯çŠ¶æ€: <span id="backendStatus" class="status offline">æœªè¿æ¥</span>
                æ™ºè°±AIçŠ¶æ€: <span id="zhipuStatus" class="status offline">æœªçŸ¥</span>
            </div>
        </div>

        <!-- è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ”Œ è¿æ¥æµ‹è¯•</h3>
            <p>æµ‹è¯•åç«¯æœåŠ¡å’Œæ™ºè°±AIæœåŠ¡çš„è¿æ¥çŠ¶æ€</p>
            <button class="btn btn-primary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button class="btn btn-secondary" onclick="getStatus()">è·å–çŠ¶æ€</button>
            <div id="connectionResult" class="result"></div>
        </div>

        <!-- æ™ºèƒ½åˆ†ææµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“Š æ™ºèƒ½æ•°æ®åˆ†ææµ‹è¯•</h3>
            <div class="form-group">
                <label>åˆ†æä¸Šä¸‹æ–‡:</label>
                <select id="analysisContext">
                    <option value="general">é€šç”¨åˆ†æ</option>
                    <option value="kpi">KPIåˆ†æ</option>
                    <option value="performance">æ€§èƒ½åˆ†æ</option>
                    <option value="economic">ç»æµåˆ†æ</option>
                    <option value="prediction">é¢„æµ‹åˆ†æ</option>
                    <option value="geo">åœ°ç†åˆ†æ</option>
                </select>
            </div>
            <div class="form-group">
                <label>åˆ†æé—®é¢˜:</label>
                <textarea id="analysisQuery" placeholder="è¯·è¾“å…¥æ‚¨çš„åˆ†æé—®é¢˜ï¼Œä¾‹å¦‚ï¼šåˆ†æå½“å‰ç³»ç»Ÿè¿è¡ŒçŠ¶å†µå¹¶ç»™å‡ºä¼˜åŒ–å»ºè®®">åˆ†æå½“å‰CCUç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µï¼Œé‡ç‚¹å…³æ³¨CO2æ•é›†ç‡å’Œèƒ½è€—æŒ‡æ ‡ï¼Œç»™å‡ºä¼˜åŒ–å»ºè®®ã€‚</textarea>
            </div>
            <button class="btn btn-primary" onclick="testAnalysis()">å¼€å§‹åˆ†æ</button>
            <div id="analysisResult" class="result"></div>
        </div>

        <!-- æ™ºèƒ½å¯¹è¯æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ’¬ æ™ºèƒ½å¯¹è¯æµ‹è¯•</h3>
            <div class="form-group">
                <label>ä¼šè¯ID (å¯é€‰):</label>
                <input type="text" id="sessionId" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆæ–°ä¼šè¯">
            </div>
            <div class="form-group">
                <label>å¯¹è¯ä¸Šä¸‹æ–‡:</label>
                <select id="chatContext">
                    <option value="general">é€šç”¨å¯¹è¯</option>
                    <option value="kpi">KPIä¸“å®¶</option>
                    <option value="performance">æŠ€æœ¯ä¸“å®¶</option>
                    <option value="economic">ç»æµä¸“å®¶</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ¶ˆæ¯å†…å®¹:</label>
                <textarea id="chatMessage" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æ¶ˆæ¯">ä½ å¥½ï¼Œæˆ‘æ˜¯æ²ªç¢³æ™ºè„‘å¹³å°çš„æ“ä½œå‘˜ï¼Œè¯·ä»‹ç»ä¸€ä¸‹CCUæŠ€æœ¯çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚</textarea>
            </div>
            <button class="btn btn-primary" onclick="testChat()">å‘é€æ¶ˆæ¯</button>
            <button class="btn btn-secondary" onclick="clearSession()">æ¸…é™¤ä¼šè¯</button>
            <div id="chatResult" class="result"></div>
        </div>

        <!-- é¢„è®¾é—®é¢˜æµ‹è¯• -->
        <div class="test-section">
            <h3>âš¡ å¿«é€Ÿæµ‹è¯•</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¿«é€Ÿæµ‹è¯•ä¸åŒåœºæ™¯çš„æ™ºè°±AIå›å¤</p>
            <button class="btn btn-secondary" onclick="quickTest('kpi')">KPIåˆ†æ</button>
            <button class="btn btn-secondary" onclick="quickTest('performance')">æ€§èƒ½åˆ†æ</button>
            <button class="btn btn-secondary" onclick="quickTest('economic')">ç»æµåˆ†æ</button>
            <button class="btn btn-secondary" onclick="quickTest('prediction')">é¢„æµ‹åˆ†æ</button>
            <div id="quickTestResult" class="result"></div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        
        // æ£€æŸ¥åç«¯è¿æ¥çŠ¶æ€
        async function checkBackendStatus() {
            try {
                const response = await fetch('/health');
                if (response.ok) {
                    document.getElementById('backendStatus').textContent = 'å·²è¿æ¥';
                    document.getElementById('backendStatus').className = 'status online';
                    return true;
                }
            } catch (error) {
                console.error('åç«¯è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
            }
            
            document.getElementById('backendStatus').textContent = 'æœªè¿æ¥';
            document.getElementById('backendStatus').className = 'status offline';
            return false;
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const resultEl = document.getElementById('connectionResult');
            resultEl.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
            resultEl.className = 'result loading';
            
            try {
                const response = await fetch('/api/llm/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                resultEl.textContent = JSON.stringify(data, null, 2);
                resultEl.className = data.success ? 'result success' : 'result error';
                
                if (data.success) {
                    document.getElementById('zhipuStatus').textContent = 'å·²è¿æ¥';
                    document.getElementById('zhipuStatus').className = 'status online';
                }
                
            } catch (error) {
                resultEl.textContent = `è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // è·å–çŠ¶æ€
        async function getStatus() {
            const resultEl = document.getElementById('connectionResult');
            resultEl.textContent = 'æ­£åœ¨è·å–çŠ¶æ€...';
            resultEl.className = 'result loading';
            
            try {
                const response = await fetch('/api/llm/status');
                const data = await response.json();
                
                resultEl.textContent = JSON.stringify(data, null, 2);
                resultEl.className = 'result success';
                
                if (data.data && data.data.isAvailable) {
                    document.getElementById('zhipuStatus').textContent = 'å¯ç”¨';
                    document.getElementById('zhipuStatus').className = 'status online';
                }
                
            } catch (error) {
                resultEl.textContent = `çŠ¶æ€è·å–å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // æµ‹è¯•æ™ºèƒ½åˆ†æ
        async function testAnalysis() {
            const context = document.getElementById('analysisContext').value;
            const query = document.getElementById('analysisQuery').value;
            const resultEl = document.getElementById('analysisResult');
            
            if (!query.trim()) {
                alert('è¯·è¾“å…¥åˆ†æé—®é¢˜');
                return;
            }
            
            resultEl.textContent = 'æ™ºè°±AIæ­£åœ¨åˆ†æä¸­...';
            resultEl.className = 'result loading';
            
            try {
                const response = await fetch('/api/llm/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        context: context,
                        data: getSampleData(context)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    let displayText = `åˆ†æç»“æœ:\n${result.response}\n\n`;
                    
                    if (result.suggestions && result.suggestions.length > 0) {
                        displayText += `å»ºè®®:\n${result.suggestions.map(s => `â€¢ ${s}`).join('\n')}\n\n`;
                    }
                    
                    displayText += `ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%\n`;
                    displayText += `ä¸Šä¸‹æ–‡: ${result.context}\n`;
                    
                    if (result.usage) {
                        displayText += `Tokenä½¿ç”¨: ${JSON.stringify(result.usage)}`;
                    }
                    
                    resultEl.textContent = displayText;
                    resultEl.className = 'result success';
                } else {
                    resultEl.textContent = `åˆ†æå¤±è´¥: ${data.error?.message || 'æœªçŸ¥é”™è¯¯'}`;
                    resultEl.className = 'result error';
                }
                
            } catch (error) {
                resultEl.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // æµ‹è¯•æ™ºèƒ½å¯¹è¯
        async function testChat() {
            const sessionId = document.getElementById('sessionId').value || currentSessionId;
            const context = document.getElementById('chatContext').value;
            const message = document.getElementById('chatMessage').value;
            const resultEl = document.getElementById('chatResult');
            
            if (!message.trim()) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }
            
            resultEl.textContent = 'æ™ºè°±AIæ­£åœ¨å›å¤ä¸­...';
            resultEl.className = 'result loading';
            
            try {
                const response = await fetch('/api/llm/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: sessionId,
                        context: context
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    currentSessionId = result.sessionId;
                    document.getElementById('sessionId').value = currentSessionId;
                    
                    let displayText = `AIå›å¤:\n${result.response}\n\n`;
                    displayText += `ä¼šè¯ID: ${result.sessionId}\n`;
                    displayText += `ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%\n`;
                    
                    if (result.suggestions && result.suggestions.length > 0) {
                        displayText += `\nç›¸å…³å»ºè®®:\n${result.suggestions.map(s => `â€¢ ${s}`).join('\n')}`;
                    }
                    
                    resultEl.textContent = displayText;
                    resultEl.className = 'result success';
                } else {
                    resultEl.textContent = `å¯¹è¯å¤±è´¥: ${data.error?.message || 'æœªçŸ¥é”™è¯¯'}`;
                    resultEl.className = 'result error';
                }
                
            } catch (error) {
                resultEl.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // æ¸…é™¤ä¼šè¯
        function clearSession() {
            currentSessionId = null;
            document.getElementById('sessionId').value = '';
            document.getElementById('chatResult').textContent = 'ä¼šè¯å·²æ¸…é™¤';
            document.getElementById('chatResult').className = 'result';
        }
        
        // å¿«é€Ÿæµ‹è¯•
        async function quickTest(type) {
            const queries = {
                kpi: 'åˆ†æå½“å‰KPIæŒ‡æ ‡è¡¨ç°ï¼Œè¯†åˆ«éœ€è¦å…³æ³¨çš„é—®é¢˜',
                performance: 'è¯„ä¼°ç³»ç»ŸæŠ€æœ¯æ€§èƒ½ï¼Œæå‡ºä¼˜åŒ–å»ºè®®',
                economic: 'åˆ†ææˆæœ¬æ•ˆç›Šï¼Œå»ºè®®é™æœ¬å¢æ•ˆç­–ç•¥',
                prediction: 'åŸºäºé¢„æµ‹æ•°æ®ï¼Œç»™å‡ºè¿è¡Œè°ƒæ•´å»ºè®®'
            };
            
            const resultEl = document.getElementById('quickTestResult');
            resultEl.textContent = 'æ™ºè°±AIæ­£åœ¨åˆ†æä¸­...';
            resultEl.className = 'result loading';
            
            try {
                const response = await fetch('/api/llm/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: queries[type],
                        context: type,
                        data: getSampleData(type)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultEl.textContent = `ã€${type.toUpperCase()}å¿«é€Ÿæµ‹è¯•ã€‘\n\n${data.data.response}`;
                    resultEl.className = 'result success';
                } else {
                    resultEl.textContent = `å¿«é€Ÿæµ‹è¯•å¤±è´¥: ${data.error?.message || 'æœªçŸ¥é”™è¯¯'}`;
                    resultEl.className = 'result error';
                }
                
            } catch (error) {
                resultEl.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // è·å–ç¤ºä¾‹æ•°æ®
        function getSampleData(context) {
            const sampleData = {
                kpi: {
                    totalInvestment: { value: 2.8, unit: 'äº¿å…ƒ', change: '+2.5%' },
                    co2Capture: { value: 156.8, unit: 'å¨/å°æ—¶', change: '+12.3%' },
                    methanolProduction: { value: 24.6, unit: 'å¨/å°æ—¶', change: '+8.7%' },
                    realTimeProfit: { value: 18.9, unit: 'ä¸‡å…ƒ/å°æ—¶', change: '+15.2%' }
                },
                performance: {
                    timestamps: Array.from({length: 24}, (_, i) => new Date(Date.now() - (23-i) * 3600000).toISOString()),
                    captureRate: Array.from({length: 24}, () => 85 + Math.random() * 10),
                    energyConsumption: Array.from({length: 24}, () => 3.2 + Math.random() * 0.8)
                },
                economic: {
                    costBreakdown: {
                        electricity: 45000,
                        solvent: 28000,
                        labor: 15000,
                        maintenance: 12000,
                        other: 8000
                    }
                }
            };
            
            return sampleData[context] || {};
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            checkBackendStatus();
            setTimeout(() => {
                getStatus();
            }, 1000);
        });
    </script>
</body>
</html>